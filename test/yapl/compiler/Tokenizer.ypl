package yapl.compiler

import yapl.collection.ArrayList
import yapl.compiler.{
	Reader
	TokenStream
	token.{
		Token
		TokenCharLiteral
		TokenIdentifier
		TokenLineComment
		TokenNewline
		TokenSemicolon
		TokenStringLiteral
		TokenWhitespace
	}
}

fun isNewline(c) = c == '\n'
fun isWhitespace(c) = c == ' ' or c == '\t'

class Tokenizer {
	fun tokenize(reader: Reader) -> TokenStream {
		val tokens = ArrayList()
		var errored = false

		fun yield(token) {
			tokens->add(token)
		}

		fun error() {
			errored = true
		}

		while not errored and (val c = reader->next()) != null do {
			if isNewline(c) then yield(TokenNewline())
			else if isWhitespace(c) then {
				yield(TokenWhitespace(c ~ reader->takeWhile(isWhitespace)))
			} else if c == '#' then yield(TokenLineComment(reader->takeWhile(fun (it) = not isNewline(it))))
			else if c == ';' then yield(TokenSemicolon())
			else if c == '\'' then {
				yield(TokenCharLiteral(reader->readMaybeEscaped()))
				if not reader->take('\'') then error("Expected '")
			} else if c == '"' then {
				var str = ""
				while not reader->eof() and reader->peek() != '"' do {
					str = str ~ reader->readMaybeEscaped()
				}
				if not reader->take('"') then error("Expected \"")
				yield(TokenStringLiteral(str))
			}
		}

		TokenStream(tokens)
	}
}
